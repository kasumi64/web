<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node-MySQL 官方文档 | 开发手册</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/web/handbooks/assets/OneNote Notebooks.png">
    <link rel="apple-touch-icon" href="/web/handbooks/assets/OneNote Notebooks.png" sizes="72x72">
    <link rel="mask-icon" href="/web/handbooks/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="开发手册，语法手记，环境搭建">
    <meta property="og:url" content="/guide/Node-MySQL.html">
    <meta property="og:site_name" content="开发手册">
    <meta property="og:title" content="Node-MySQL 官方文档">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="开发手册">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/web/handbooks/assets/css/0.styles.92ed05f9.css" as="style"><link rel="preload" href="/web/handbooks/assets/js/app.34fee4e2.js" as="script"><link rel="preload" href="/web/handbooks/assets/js/layout-Layout.e2428f23.js" as="script"><link rel="preload" href="/web/handbooks/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.6b13e837.js" as="script"><link rel="preload" href="/web/handbooks/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.2463fd57.js" as="script"><link rel="preload" href="/web/handbooks/assets/js/vendors~layout-Blog~layout-Layout.80e40fa9.js" as="script"><link rel="preload" href="/web/handbooks/assets/js/page-Node-MySQL官方文档--810d1eb0.e4ae1425.js" as="script"><link rel="prefetch" href="/web/handbooks/assets/js/44.511c057e.js"><link rel="prefetch" href="/web/handbooks/assets/js/45.686a33aa.js"><link rel="prefetch" href="/web/handbooks/assets/js/46.547c1531.js"><link rel="prefetch" href="/web/handbooks/assets/js/47.161400a9.js"><link rel="prefetch" href="/web/handbooks/assets/js/48.ffa56e4a.js"><link rel="prefetch" href="/web/handbooks/assets/js/49.443ad282.js"><link rel="prefetch" href="/web/handbooks/assets/js/layout-Blog.50b4ca94.js"><link rel="prefetch" href="/web/handbooks/assets/js/layout-NotFound.cdaf11ac.js"><link rel="prefetch" href="/web/handbooks/assets/js/layout-Slide.990633eb.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-About--8eaf4b22.f5f01af2.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Array数组--01456e5e.51ed83f8.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Boolean布尔值--f27b829a.aa2915fc.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Browser浏览器对象--434240b3.25616f9b.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Cordova应用流程--2213e961.89acb8f6.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Date日期时间--8a4d2046.a0be5b07.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Electron桌面应用--d04b6fd2.576bc9ad.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Events事件--4c5e2986.0646bea0.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Function函数--cf4504c6.5b37d87f.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Git常用命令大全--655cb23c.69dfc1e0.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Global全局函数--1f0763fd.727120f9.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-H5的桌面应用打包工具--730675d8.80f39607.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-HBuilderMarkdown语法大纲--6263d792.3d91cc5b.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Home--f4f55a84.98592ab4.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-JavaScript常用新特性--a1780ec6.4f22938d.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-JavaScript核心参考手册--1d2724e4.6df80b55.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Linux手册--1f3bfc30.da67a4b5.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Markdown语法--9f3f0690.3eb33045.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Math数学函数--3c01cd1d.791bd197.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-MySql增删改查--26ee233d.970a9bbd.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-MySql手册--2b8d6df0.0579fdb9.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Number数字--6c79d53d.b14d5cfe.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Object对像--bbbee706.08a06b8b.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-React-App--3e87f348.dd71b5a0.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-RegExp正则表达式--67ea7d86.568861b0.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-String字符串--4b13043d.752b85a2.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-VisualStudioCode相关插件与配置--7ca3068a.35426bc4.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-Vue-Cli--0b9e0558.a4471872.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-代码风格--77d10918.ac8794d8.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-包管理工具--7f12d98a.b794d42e.js"><link rel="prefetch" href="/web/handbooks/assets/js/page-数据库--91c4eb64.7b5a88dd.js"><link rel="prefetch" href="/web/handbooks/assets/js/vendors~flowchart.10982a0f.js"><link rel="prefetch" href="/web/handbooks/assets/js/vendors~photo-swipe.e19a2e69.js"><link rel="prefetch" href="/web/handbooks/assets/js/vendors~reveal.63bf05c9.js">
    <link rel="stylesheet" href="/web/handbooks/assets/css/0.styles.92ed05f9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-anchor"><header class="navbar"><button class="sidebar-button"><span class="icon"></span></button> <a href="/web/handbooks/" class="home-link router-link-active"><img src="/web/handbooks/assets/Scrapbook.png" alt="开发手册" class="logo"> <!----> <span class="site-name can-hide">开发手册</span></a> <div class="links"><button class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><a href="#" class="default-theme"></a></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0042.667-42.667V128a42.667 42.667 0 00-85.334 0v85.333A42.667 42.667 0 00512 256zm384 213.333h-85.333a42.667 42.667 0 000 85.334H896a42.667 42.667 0 000-85.334zM256 512a42.667 42.667 0 00-42.667-42.667H128a42.667 42.667 0 000 85.334h85.333A42.667 42.667 0 00256 512zm9.387-298.667a42.667 42.667 0 00-59.307 62.72l61.44 59.307a42.667 42.667 0 0031.147 11.947 42.667 42.667 0 0030.72-13.227 42.667 42.667 0 000-60.16zm459.946 133.974a42.667 42.667 0 0029.44-11.947l61.44-59.307a42.667 42.667 0 00-57.6-62.72l-61.44 60.587a42.667 42.667 0 000 60.16 42.667 42.667 0 0028.16 13.227zM512 768a42.667 42.667 0 00-42.667 42.667V896a42.667 42.667 0 0085.334 0v-85.333A42.667 42.667 0 00512 768zm244.48-79.36a42.667 42.667 0 00-59.307 61.44l61.44 60.587a42.667 42.667 0 0029.44 11.946 42.667 42.667 0 0030.72-12.8 42.667 42.667 0 000-60.586zm-488.96 0l-61.44 59.307a42.667 42.667 0 000 60.586 42.667 42.667 0 0030.72 12.8 42.667 42.667 0 0028.587-10.666l61.44-59.307a42.667 42.667 0 00-59.307-61.44zM512 341.333A170.667 170.667 0 10682.667 512 170.667 170.667 0 00512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 00-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 00-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title"><!---->
      API
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title"><!---->
      API
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/handbooks/api/JavaScript/" class="nav-link"><!---->
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/api/database/" class="nav-link"><!---->
  数据库
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Guide" class="dropdown-title"><span class="title"><!---->
      Guide
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="Guide" class="mobile-dropdown-title"><span class="title"><!---->
      Guide
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/handbooks/guide/MySql.html" class="nav-link"><!---->
  MySql手册
</a></li><li class="dropdown-subitem"><a href="/web/handbooks/guide/Node-MySQL.html" class="nav-link"><!---->
  Node-MySQL
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/web/handbooks/guide/linux.html" class="nav-link"><!---->
  Linux语法
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/guide/markdown.html" class="nav-link"><!---->
  Markdown语法
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/guide/HBuilderMarkdown.html" class="nav-link"><!---->
  HBuilderX (MD)
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/guide/ESLint.html" class="nav-link"><!---->
  ESLint
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🛠 搭建" class="dropdown-title"><span class="title"><!---->
      🛠 搭建
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="🛠 搭建" class="mobile-dropdown-title"><span class="title"><!---->
      🛠 搭建
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/handbooks/deploy/desktop/" class="nav-link"><!---->
  桌面应用
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/deploy/git.html" class="nav-link"><!---->
  Git
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/deploy/npm-yarn.html" class="nav-link"><!---->
  npm与yarn
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/deploy/vue-cli.html" class="nav-link"><!---->
  Vue-cli
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/deploy/react.html" class="nav-link"><!---->
  React-cli
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/deploy/vsCode.html" class="nav-link"><!---->
  VSCode
</a></li></ul></div></div><div class="nav-item"><a href="/web/handbooks/about/" class="nav-link"><!---->
  About
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title"><!---->
      API
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title"><!---->
      API
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/handbooks/api/JavaScript/" class="nav-link"><!---->
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/api/database/" class="nav-link"><!---->
  数据库
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Guide" class="dropdown-title"><span class="title"><!---->
      Guide
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="Guide" class="mobile-dropdown-title"><span class="title"><!---->
      Guide
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/handbooks/guide/MySql.html" class="nav-link"><!---->
  MySql手册
</a></li><li class="dropdown-subitem"><a href="/web/handbooks/guide/Node-MySQL.html" class="nav-link"><!---->
  Node-MySQL
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/web/handbooks/guide/linux.html" class="nav-link"><!---->
  Linux语法
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/guide/markdown.html" class="nav-link"><!---->
  Markdown语法
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/guide/HBuilderMarkdown.html" class="nav-link"><!---->
  HBuilderX (MD)
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/guide/ESLint.html" class="nav-link"><!---->
  ESLint
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🛠 搭建" class="dropdown-title"><span class="title"><!---->
      🛠 搭建
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="🛠 搭建" class="mobile-dropdown-title"><span class="title"><!---->
      🛠 搭建
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/handbooks/deploy/desktop/" class="nav-link"><!---->
  桌面应用
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/deploy/git.html" class="nav-link"><!---->
  Git
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/deploy/npm-yarn.html" class="nav-link"><!---->
  npm与yarn
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/deploy/vue-cli.html" class="nav-link"><!---->
  Vue-cli
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/deploy/react.html" class="nav-link"><!---->
  React-cli
</a></li><li class="dropdown-item"><!----> <a href="/web/handbooks/deploy/vsCode.html" class="nav-link"><!---->
  VSCode
</a></li></ul></div></div><div class="nav-item"><a href="/web/handbooks/about/" class="nav-link"><!---->
  About
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/web/handbooks/guide/MySql/" class="sidebar-heading clickable open"><!----> <span>数据库</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/web/handbooks/guide/MySql/" class="sidebar-link">MySql手册</a></li><li><a href="/web/handbooks/guide/Node-MySQL/" aria-current="page" class="active sidebar-link">Node-MySQL</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#如何建立链接" class="sidebar-link">如何建立链接</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#连接参数" class="sidebar-link">连接参数</a></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#终止连接" class="sidebar-link">终止连接</a></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#连接池连接" class="sidebar-link">连接池连接</a></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#连接池的配置参数" class="sidebar-link">连接池的配置参数</a></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#连接池的事件" class="sidebar-link">连接池的事件</a></li></ul></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#集群连接池" class="sidebar-link">集群连接池</a></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#执行查询" class="sidebar-link">执行查询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#查询值转义" class="sidebar-link">查询值转义</a></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#查询标识符转义" class="sidebar-link">查询标识符转义</a></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#预查询" class="sidebar-link">预查询</a></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#自定义格式" class="sidebar-link">自定义格式</a></li></ul></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#获取插入行的id" class="sidebar-link">获取插入行的id</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#取得受影响的行数" class="sidebar-link">取得受影响的行数</a></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#流式查询行" class="sidebar-link">流式查询行</a></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#通过-streams2-管道输出" class="sidebar-link">通过 Streams2 管道输出</a></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#多语句查询" class="sidebar-link">多语句查询</a></li></ul></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#存储过程" class="sidebar-link">存储过程</a></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#事务" class="sidebar-link">事务</a></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#错误处理" class="sidebar-link">错误处理</a></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#类型测试" class="sidebar-link">类型测试</a></li><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#默认标记" class="sidebar-link">默认标记</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/handbooks/guide/Node-MySQL/#其他有用的标记" class="sidebar-link">其他有用的标记</a></li></ul></li></ul></li></ul></section></li><li><a href="/web/handbooks/guide/linux/" class="sidebar-link">Linux语法</a></li><li><a href="/web/handbooks/guide/markdown/" class="sidebar-link">Markdown语法</a></li><li><a href="/web/handbooks/guide/HBuilderMarkdown/" class="sidebar-link">HBuilderX (MD)</a></li><li><a href="/web/handbooks/guide/ESLint/" class="sidebar-link">ESLint</a></li></ul> </aside> <main class="page"><nav class="breadcrumb disable"><!----></nav>  <div class="page-title"><h1><!---->
    Node-MySQL 官方文档
  </h1> <div class="page-info"><!----> <!----><span aria-label="Page views🔢" data-balloon-pos="down" class="visitor-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon eye-icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z" fill="currentColor"></path></svg> <span id="/web/handbooks/guide/Node-MySQL/" data-flag-title="Node-MySQL 官方文档" class="leancloud_visitors"><span class="leancloud-visitors-count">...</span></span></span><!----><!----><!----><span aria-label="Reading Time⌛" data-balloon-pos="down" class="read-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon time-icon"><path d="M511.997 70.568c-243.797 0-441.429 197.633-441.429 441.435 0 243.797 197.632 441.429 441.43 441.429S953.431 755.8 953.431 512.002c0-243.796-197.637-441.434-441.435-441.434zm150.158 609.093l-15.605 15.61c-8.621 8.615-22.596 8.615-31.215 0L472.197 552.126c-4.95-4.944-4.34-14.888-4.34-24.677V247.14c0-12.19 9.882-22.07 22.07-22.07h22.07c12.19 0 22.07 9.882 22.07 22.07v273.218l128.088 128.088c8.62 8.62 8.62 22.595 0 31.215zm0 0" fill="currentColor"></path></svg> <span>About 27 min</span></span></div> <hr></div> <!----> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor anchor2"><a href="/web/handbooks/guide/Node-MySQL/#如何建立链接" class="anchor-link"><div>如何建立链接</div></a><ul class="anchor-list"><li class="anchor anchor3"><a href="/web/handbooks/guide/Node-MySQL/#连接参数" class="anchor-link"><div>连接参数</div></a></li><li class="anchor anchor3"><a href="/web/handbooks/guide/Node-MySQL/#终止连接" class="anchor-link"><div>终止连接</div></a></li><li class="anchor anchor3"><a href="/web/handbooks/guide/Node-MySQL/#连接池连接" class="anchor-link"><div>连接池连接</div></a></li><li class="anchor anchor3"><a href="/web/handbooks/guide/Node-MySQL/#连接池的配置参数" class="anchor-link"><div>连接池的配置参数</div></a></li><li class="anchor anchor3"><a href="/web/handbooks/guide/Node-MySQL/#连接池的事件" class="anchor-link"><div>连接池的事件</div></a></li></ul></li><li class="anchor anchor2"><a href="/web/handbooks/guide/Node-MySQL/#集群连接池" class="anchor-link"><div>集群连接池</div></a></li><li class="anchor anchor2"><a href="/web/handbooks/guide/Node-MySQL/#执行查询" class="anchor-link"><div>执行查询</div></a><ul class="anchor-list"><li class="anchor anchor3"><a href="/web/handbooks/guide/Node-MySQL/#查询值转义" class="anchor-link"><div>查询值转义</div></a></li><li class="anchor anchor3"><a href="/web/handbooks/guide/Node-MySQL/#查询标识符转义" class="anchor-link"><div>查询标识符转义</div></a></li><li class="anchor anchor3"><a href="/web/handbooks/guide/Node-MySQL/#预查询" class="anchor-link"><div>预查询</div></a></li><li class="anchor anchor3"><a href="/web/handbooks/guide/Node-MySQL/#自定义格式" class="anchor-link"><div>自定义格式</div></a></li></ul></li><li class="anchor anchor2"><a href="/web/handbooks/guide/Node-MySQL/#获取插入行的id" class="anchor-link"><div>获取插入行的id</div></a><ul class="anchor-list"><li class="anchor anchor3"><a href="/web/handbooks/guide/Node-MySQL/#取得受影响的行数" class="anchor-link"><div>取得受影响的行数</div></a></li><li class="anchor anchor3"><a href="/web/handbooks/guide/Node-MySQL/#流式查询行" class="anchor-link"><div>流式查询行</div></a></li><li class="anchor anchor3"><a href="/web/handbooks/guide/Node-MySQL/#通过-streams2-管道输出" class="anchor-link"><div>通过 Streams2 管道输出</div></a></li><li class="anchor anchor3"><a href="/web/handbooks/guide/Node-MySQL/#多语句查询" class="anchor-link"><div>多语句查询</div></a></li></ul></li><li class="anchor anchor2"><a href="/web/handbooks/guide/Node-MySQL/#存储过程" class="anchor-link"><div>存储过程</div></a></li><li class="anchor anchor2"><a href="/web/handbooks/guide/Node-MySQL/#事务" class="anchor-link"><div>事务</div></a></li><li class="anchor anchor2"><a href="/web/handbooks/guide/Node-MySQL/#错误处理" class="anchor-link"><div>错误处理</div></a></li><li class="anchor anchor2"><a href="/web/handbooks/guide/Node-MySQL/#类型测试" class="anchor-link"><div>类型测试</div></a></li><li class="anchor anchor2"><a href="/web/handbooks/guide/Node-MySQL/#默认标记" class="anchor-link"><div>默认标记</div></a><ul class="anchor-list"><li class="anchor anchor3"><a href="/web/handbooks/guide/Node-MySQL/#其他有用的标记" class="anchor-link"><div>其他有用的标记</div></a></li></ul></li></ul></div></aside></div> <div class="theme-default-content content__default"><h1 id="node-mysql-官方文档"><a href="#node-mysql-官方文档" class="header-anchor">#</a> Node-MySQL 官方文档</h1> <p><a href="https://www.oschina.net/translate/node-mysql-tutorial?lang=chs" target="_blank" rel="noopener noreferrer">中文已翻译 100%<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br> <a href="https://github.com/mysqljs/mysql/blob/master/Readme.md" target="_blank" rel="noopener noreferrer">英文<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>安装</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>npm install mysql <span class="token operator">--</span>save
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>有关之前的0.9.x版本的信息, 请访问 <a href="https://github.com/mysqljs/mysql/tree/v0.9" target="_blank" rel="noopener noreferrer">v0.9分支<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。<br>
有时我还会要求你从Github安装最新版以检查bug是否已修复。在这种情况下，请输入:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>npm install mysqljs<span class="token operator">/</span>mysql
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>引言</strong><br>
这是node.js的mysql驱动。它是用JavaScript编写的，不需要编译，完全遵循MIT许可协议。<br>
下面是一个如何使用它的例子:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> mysql      <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host     <span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
  user     <span class="token operator">:</span> <span class="token string">'me'</span><span class="token punctuation">,</span>
  password <span class="token operator">:</span> <span class="token string">'secret'</span><span class="token punctuation">,</span>
  database <span class="token operator">:</span> <span class="token string">'my_db'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT 1 + 1 AS solution'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> rows<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The solution is: '</span><span class="token punctuation">,</span> rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>solution<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>从这个例子中，你可以了解到以下几点:</p> <ul><li>对于一个连接，你所调用的每个方法都是按顺序排队并依次执行的。</li> <li>使用end()关闭连接，以确保给mysql服务器发送退出（quit）包以前执行所有剩余的查询。</li></ul> <h2 id="如何建立链接"><a href="#如何建立链接" class="header-anchor">#</a> 如何建立链接</h2> <ul><li>推荐的建立链接的一个方法：</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> mysql      <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host     <span class="token operator">:</span> <span class="token string">'example.org'</span><span class="token punctuation">,</span>
  user     <span class="token operator">:</span> <span class="token string">'bob'</span><span class="token punctuation">,</span>
  password <span class="token operator">:</span> <span class="token string">'secret'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'error connecting: '</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'connected as id '</span> <span class="token operator">+</span> connection<span class="token punctuation">.</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>然后，我们可以通过建立一个连接来进行查询：</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> mysql      <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT 1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> rows</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// connected! (unless `err` is set)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>以上二种方法都是正确且合适的。至于如何取舍，就要看你怎么去处理所遇到的错误了。不管哪种类型的错误，那都是致命的，我们需要去看所提示的具体的错误信息。</p> <h3 id="连接参数"><a href="#连接参数" class="header-anchor">#</a> <strong>连接参数</strong></h3> <p>在建立新连接时，可以设置以下参数：</p> <ul><li>host：连接的数据库地址。（默认:localhost）</li> <li>port：连接地址对应的端口。（默认:3306）</li> <li>localAddress: 源IP地址使用TCP连接。（可选）</li> <li>socketPath:当主机和端口参数被忽略的时候，可以填写一个Unix的Socket地址。</li> <li>user: mysql的连接用户名。</li> <li>password: 对应用户的密码。</li> <li>database: 所需要连接的数据库的名称。（可选）</li> <li>charset: 连接的编码形式。这就是mysql中的整理。（例如：utf8_general_ci）如果被指定，则作为默认的整理排序规则。（默认：utf8_general_ci）</li> <li>timezone:用来保存当前本地的时区。（默认：local）</li> <li>connectTimeout: 设置在连接的时候，超过多久以后未响应则返回失败。（默认：10000）</li> <li>stringifyObjects: stringify对象代替转换值。issue# 501。（默认：false）</li> <li>insecureAuth：使用旧（不安全）的连接方式去连接MySQL。（默认：false）</li> <li>typeCast: 确定列值是否需要转换为本地JavaScript类型。（默认：true）</li> <li>queryFormat:自定义查询的方式。地址：<a href="https://github.com/mysqljs/mysql#custom-format" target="_blank" rel="noopener noreferrer">Custom format<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>supportBigNumbers: 如果你使用了BIGINT和DECIMAL格式的表列，那么需要开启这个参数来支持。（默认：false）只有当他们超过JavaScript所能表达的最长的字节的时候，如果没有设置这个参数，则会将过长的数字作为字符串传递。否则，返回对象的长度。如果supportBigNumbers参数被忽略，则这个参数也会被忽略。</li> <li>dateStrings:一些日期类型(TIMESTAMP, DATETIME, DATE)会以Strings的类型返回，然后转换成JavaScript的日期对象。（默认：false）</li> <li>debug:是否把连接情况打印到文件。（默认：false）</li> <li>trace: 生成错误的堆栈跟踪，包括库入口的调用位置（“长堆栈的轨迹”）。一般会造成轻微的性能损失。（默认：true）</li></ul> <h3 id="终止连接"><a href="#终止连接" class="header-anchor">#</a> <strong>终止连接</strong></h3> <p>终止连接的方法有两种。调用end()方法可以正常地终止一个连接：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 连接终止</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这种方法将确保给MySQL服务器发送COM_QUIT包之前所有队列中的查询都会被执行。如果在发送COM_QUIT包之前发生了致命错误，那么会给回调函数传递一个err参数，但是不管怎样连接都会关闭。</p> <p>另外一种终止连接的方法是调用destroy()方法。该方法会立即终止底层套接字（underlying socket）。另外，destroy()不会触发更多的事件和回调函数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>和end()方法不同，destroy()方法不使用回调参数。</p> <h3 id="连接池连接"><a href="#连接池连接" class="header-anchor">#</a> <strong>连接池连接</strong></h3> <p>直接使用连接池。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> pool  <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  connectionLimit <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  host            <span class="token operator">:</span> <span class="token string">'example.org'</span><span class="token punctuation">,</span>
  user            <span class="token operator">:</span> <span class="token string">'bob'</span><span class="token punctuation">,</span>
  password        <span class="token operator">:</span> <span class="token string">'secret'</span><span class="token punctuation">,</span>
  database        <span class="token operator">:</span> <span class="token string">'my_db'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pool<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT 1 + 1 AS solution'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> rows<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The solution is: '</span><span class="token punctuation">,</span> rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>solution<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>使用连接池连接可以更容易地共享某个连接，也可以管理多个连接。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> pool  <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host     <span class="token operator">:</span> <span class="token string">'example.org'</span><span class="token punctuation">,</span>
  user     <span class="token operator">:</span> <span class="token string">'bob'</span><span class="token punctuation">,</span>
  password <span class="token operator">:</span> <span class="token string">'secret'</span><span class="token punctuation">,</span>
  database <span class="token operator">:</span> <span class="token string">'my_db'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pool<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// connected! (unless `err` is set)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>当连接完成后，调用connection.release()方法使连接返回到连接池，以便其他人可以再次使用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> pool  <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pool<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用连接</span>
  connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span> <span class="token string">'SELECT something FROM sometable'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> rows</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用连接执行查询</span>
    connection<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//连接不再使用，返回到连接池</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>如果你想关闭连接并从连接池中删除它，就要使用connection.destroy()方法。在下次需要时连接池会再创建一个新的连接。</p> <p>连接池创建连接很慵懒。如果你配置的连接池最大支持100个连接，但同时只使用了5个连接，那么它只创建5个连接。连接还采用了循环轮转方式，即连接建立在连接池顶部，返回到连接池底部。</p> <p>当从连接池中恢复之前的某个连接时，会给服务器发送一个ping包以检查连接是否正常。</p> <h3 id="连接池的配置参数"><a href="#连接池的配置参数" class="header-anchor">#</a> <strong>连接池的配置参数</strong></h3> <p>连接池接受所有与连接相同的<a href="https://github.com/mysqljs/mysql#connection-options" target="_blank" rel="noopener noreferrer">配置参数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。创建新连接时，配置参数只是简单的传给连接对象的构造器。除此配置外，连接池还支持一些额外的参数：</p> <ul><li>acquireTimeout（获取超时时间）: 获取连接时，触发连接超时之前的毫秒数。这与connectTimeout略有不同，因为从连接池获取连接并不总会创建连接 （默认值：10000）</li> <li>waitForConnections(连接等待时间）:  当无连接可用或连接数达到上限的时候，判定连接池动作。如果为true，连接池会将请求加入队列，待可用之时再触发操作；如为false，连接池将立即返回错误 （默认值：true)</li> <li>connectionLimit(连接数限制): 所允许立即创建的最大连接数量 (默认值: 10)</li> <li>queueLimit（队列数量限制）: 在调用getConnection返回错误之前，连接池所允许入队列的最大请求数量。如设置为0， 则不限制。 (默认值: 0)</li></ul> <h3 id="连接池的事件"><a href="#连接池的事件" class="header-anchor">#</a> <strong>连接池的事件</strong></h3> <p><strong>连接</strong></p> <p>连接池里面创建了一个新连接时，会触发一个连接事件。如需要在使用此连接之前设置会话变量，将要对此事件进行监听。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>pool<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SET SESSION auto_increment_increment=1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>入列</strong></p> <p>队列中等待可用连接的回调函数被触发时，连接池将触发此事件。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>pool<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'enqueue'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Waiting for available connection slot'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>在连接池中关闭所有连接</strong></p> <p>如不再需要连接池时，你必须关闭所有连接。否则Node.js脚本的事件流一直处于活跃状态，最终会被MySQL服务器会关闭。脚本占用连接池，这是典型的情况！另外可以以优雅的方式的关闭服务器。关闭所有连接池中的连接，中使用end方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>pool<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// all connections in the pool have ended</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>end方法接受一个可选的回调函数，以通知（一次）所有已关闭的连接。优雅关闭连接，队列中所有的查询都能被执行，但关闭连接池的时间会不一样。</p> <p>一旦pool.end()被调用，pool.getConnection及其它操作将不再被执行！</p> <h2 id="集群连接池"><a href="#集群连接池" class="header-anchor">#</a> <strong>集群连接池</strong></h2> <p>集群连接池提供多主机连接.(分组&amp;重试&amp;选择器)</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// create</span>
<span class="token keyword">var</span> poolCluster <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPoolCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// add configurations (the config is a pool config object)</span>
poolCluster<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add configuration with automatic name</span>
poolCluster<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'MASTER'</span><span class="token punctuation">,</span> masterConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add a named configuration</span>
poolCluster<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'SLAVE1'</span><span class="token punctuation">,</span> slave1Config<span class="token punctuation">)</span><span class="token punctuation">;</span>
poolCluster<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'SLAVE2'</span><span class="token punctuation">,</span> slave2Config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// remove configurations</span>
poolCluster<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'SLAVE2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// By nodeId</span>
poolCluster<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'SLAVE*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// By target group : SLAVE1-2</span>
<span class="token comment">// Target Group : ALL(anonymous, MASTER, SLAVE1-2), Selector : round-robin(default)</span>
poolCluster<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Target Group : MASTER, Selector : round-robin</span>
poolCluster<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">'MASTER'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Target Group : SLAVE1-2, Selector : order</span>
<span class="token comment">// If can't connect to SLAVE1, return SLAVE2. (remove SLAVE1 in the cluster)</span>
poolCluster<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'remove'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">nodeId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'REMOVED NODE : '</span> <span class="token operator">+</span> nodeId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// nodeId = SLAVE1 </span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
poolCluster<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">'SLAVE*'</span><span class="token punctuation">,</span> <span class="token string">'ORDER'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// of namespace : of(pattern, selector)</span>
poolCluster<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> pool <span class="token operator">=</span> poolCluster<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">'SLAVE*'</span><span class="token punctuation">,</span> <span class="token string">'RANDOM'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pool<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pool<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// close all connections</span>
poolCluster<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// all connections in the pool cluster have ended</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p><strong>集群连接池/选项</strong></p> <ul><li>canRetry: 如果为true,当连接失效时,集群连接池将尝试重新连接. (默认: true)</li> <li>removeNodeErrorCount: 如果连接失效,节点的错误次数增加.当错误次数大于removeNodeErrorCount时,该节点从集群链接池中移除 (默认: 5)</li> <li>restoreNodeTimeout: 如果连接失效,该参数用于指定尝试获取另一个连接时需要等待的时间，时间单位为毫秒.如果为0,这个节点将被移除并且不会被重复使用.(默认值：0).</li> <li>defaultSelector: 默认选择器（默认值：RR）</li> <li>RR: 以轮询的方式选择节点. (轮询制)</li> <li>RANDOM: 使用随机函数选择节点.</li> <li>ORDER: 无条件地选择第一个可用节点.</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> clusterConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  removeNodeErrorCount<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// Remove the node immediately when connection fails.</span>
  defaultSelector<span class="token operator">:</span> <span class="token string">'ORDER'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> poolCluster <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPoolCluster</span><span class="token punctuation">(</span>clusterConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>更换用户并且改变连接状态</strong></p> <p>MySQL 提供了一个changeUser 命令，该命令允许你在不关闭下列socket的情况下，改变当前用户和连接的其余部分.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">changeUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>user <span class="token operator">:</span> <span class="token string">'john'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>该特性的可用选项有：</p> <ul><li>user: 新的用户名 (默认前一次使用的用户名).</li> <li>password: 新用户的密码(默认前一次使用的密码).</li> <li>charset: 新的字符集 (默认前一次使用的字符集).</li> <li>database: 新的数据库名称(默认前一次使用的数据库名).</li></ul> <p>有时有用的是这个功能的副作用,即会重置任何连接的状态（变量，事物等）.</p> <p>在集群连接池模式下执行changeUser操作如果遇到错误将被视为致命错误.</p> <p><strong>服务断开连接</strong></p> <p>由于网络问题、MySQL服务器重启或崩溃,连接超时等问题,你有可能会断开与MySQL服务器的连接.所有上述事件被认定为致命错误,并且将返回错误码'PROTOCOL_CONNECTION_LOST'.查看更多信息，请参照错误处理章节.</p> <p>下一个连接将以建立一个新的连接的方式来获取.当前设计下,一旦终止,现有的一个连接对象将不能够被重连.</p> <p>连接池状态下,端开的链接将会从连接池中移除并释放空间,下一次调用getConnection时将用释放的空间创建新连接。</p> <h2 id="执行查询"><a href="#执行查询" class="header-anchor">#</a> 执行查询</h2> <p>最基本的执行查询的方法是在一个对象中调用 .query()函数 (比如一个连接或应用池实例)。</p> <p>最简单的 .query()形式是 .query(sqlString, callback)，第一个参数是一条SQL字符串，第二个参数是回调：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM `books` WHERE `author` = &quot;David&quot;'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// error will be an Error if one occurred during the query</span>
  <span class="token comment">// results will contain the results of the query</span>
  <span class="token comment">// fields will contain information about the returned results fields (if any)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>第二个.query()形式是 .query(sqlString, values, callback)，带有值的占位符 (查看转义查询值):</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM `books` WHERE `author` = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'David'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// error will be an Error if one occurred during the query</span>
  <span class="token comment">// results will contain the results of the query</span>
  <span class="token comment">// fields will contain information about the returned results fields (if any)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>第三种 .query()形式是 .query(options, callback)，在查询时带有大量的高级可选项，比如 <a href="https://github.com/mysqljs/mysql#escaping-query-values" target="_blank" rel="noopener noreferrer">转义查询值(escaping query values)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，<a href="https://github.com/mysqljs/mysql#joins-with-overlapping-column-names" target="_blank" rel="noopener noreferrer">联结重叠列名(joins with overlapping column names)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，超时(timeouts), 和 <a href="https://github.com/mysqljs/mysql#type-casting" target="_blank" rel="noopener noreferrer">类型转换(type casting)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  sql<span class="token operator">:</span> <span class="token string">'SELECT * FROM `books` WHERE `author` = ?'</span><span class="token punctuation">,</span>
  timeout<span class="token operator">:</span> <span class="token number">40000</span><span class="token punctuation">,</span> <span class="token comment">// 40s</span>
  values<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'David'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// error will be an Error if one occurred during the query</span>
  <span class="token comment">// results will contain the results of the query</span>
  <span class="token comment">// fields will contain information about the returned results fields (if any)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <p>注意一种第二和第三形式的结合体也可使用，其中占位符以参数来传递，并且不能做为选项对象。值参数会覆盖选项对象中的值。</p></div> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    sql<span class="token operator">:</span> <span class="token string">'SELECT * FROM `books` WHERE `author` = ?'</span><span class="token punctuation">,</span>
    timeout<span class="token operator">:</span> <span class="token number">40000</span><span class="token punctuation">,</span> <span class="token comment">// 40s</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'David'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// error will be an Error if one occurred during the query</span>
    <span class="token comment">// results will contain the results of the query</span>
    <span class="token comment">// fields will contain information about the returned results fields (if any)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="查询值转义"><a href="#查询值转义" class="header-anchor">#</a> <strong>查询值转义</strong></h3> <p>为了防止SQL注入，每当需要在SQL查询中使用用户数据时，你都应当提前对这些值进行转义。转义可以通过 mysql.escape(), connection.escape() 或 pool.escape() 方法实现：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> userId <span class="token operator">=</span> <span class="token string">'some user provided value'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sql    <span class="token operator">=</span> <span class="token string">'SELECT * FROM users WHERE id = '</span> <span class="token operator">+</span> connection<span class="token punctuation">.</span><span class="token function">escape</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>另外，也可以使用 ? 作为查询字符串中的占位符，替代你想要转义的值。例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM users WHERE id = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>userId<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>使用多个占位符则传入的值会依次填入。例如，下方查询中foo将等于a、bar将等于b、baz将等于c，而id将会被赋值为userId的值：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'UPDATE users SET foo = ?, bar = ?, baz = ? WHERE id = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> userId<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这样看起来与MySQL中prepared statements相似，但它内部其实使用了之前的connection.escape() 方法。</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p><strong>注意</strong> 它与prepared statements的另一点不同之处是，即使是在注释和字符串中的 ? 也会被替换。</p></div> <p>不同类型的值转义的方式是有区别的，其区别如下：</p> <ul><li>数字不会被转义</li> <li>布尔值会被转移成 true / false</li> <li>Date 对象会被转义成形如 'YYYY-mm-dd HH:ii:ss' 的字符串</li> <li>Buffer 会被转义成十六进制字符串，如： X'0fa5'</li> <li>字符串会被安全地转义</li> <li>数组会被转义成列表，例如： ['a', 'b'] 会被转义成 'a', 'b'</li> <li>嵌套数组会被转义成多个列表（在大规模插入时），如： [['a', 'b'], ['c', 'd']] 会被转义成 ('a', 'b'), ('c', 'd')</li> <li>对象的所有可遍历属性会被转义成键值对。如果属性的值是函数，则会被忽略；如果属性值是对象，则会使用其 toString() 方法的返回值。</li> <li>undefined / null 会被转义成 NULL</li> <li>NaN / Infinity 将会被原样传入。由于MySQL 并不支持这些值，在它们得到支持之前，插入这些值将会导致MySQL报错。</li></ul> <p>如果你足够细心，可能已经注意到了，这种占位符转义可以写出简洁的代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> post  <span class="token operator">=</span> <span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'Hello MySQL'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> query <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO posts SET ?'</span><span class="token punctuation">,</span> post<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Neat!</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// INSERT INTO posts SET `id` = 1, `title` = 'Hello MySQL'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>当你觉得有必要亲自对这些查询进行转义时，也可以直接使用转义方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> query <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM posts WHERE title=&quot;</span> <span class="token operator">+</span> mysql<span class="token punctuation">.</span><span class="token function">escape</span><span class="token punctuation">(</span><span class="token string">&quot;Hello MySQL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// SELECT * FROM posts WHERE title='Hello MySQL'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="查询标识符转义"><a href="#查询标识符转义" class="header-anchor">#</a> <strong>查询标识符转义</strong></h3> <p>如果用户提供了不可信的查询标识符（数据库名、表名、列名），你应该用 mysql.escapeId(identifier), connection.escapeId(identifier) 或 pool.escapeId(identifier) 方法对它进行转义，如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> sorter <span class="token operator">=</span> <span class="token string">'date'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sql    <span class="token operator">=</span> <span class="token string">'SELECT * FROM posts ORDER BY '</span> <span class="token operator">+</span> connection<span class="token punctuation">.</span><span class="token function">escapeId</span><span class="token punctuation">(</span>sorter<span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>同时它还支持限定符，并对限定符两边的内容都进行转义。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> sorter <span class="token operator">=</span> <span class="token string">'date'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sql    <span class="token operator">=</span> <span class="token string">'SELECT * FROM posts ORDER BY '</span> <span class="token operator">+</span> connection<span class="token punctuation">.</span><span class="token function">escapeId</span><span class="token punctuation">(</span><span class="token string">'posts.'</span> <span class="token operator">+</span> sorter<span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>另外，你还可以用 ?? 作为占位符来替代你想要转义的标识符，如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> userId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'email'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> query <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT ?? FROM ?? WHERE id = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>columns<span class="token punctuation">,</span> <span class="token string">'users'</span><span class="token punctuation">,</span> userId<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// SELECT `username`, `email` FROM `users` WHERE id = 1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <p><strong>请注意，最后这部分的顺序是实验性的，其句法可能在之后的版本中改变。</strong><br>
当你将对象传给 .escape() 或 .query()时，为了防止SQL注入，对象的键将被 .escapeId() 转义。</p></div> <h3 id="预查询"><a href="#预查询" class="header-anchor">#</a> <strong>预查询</strong></h3> <p>你可以使用 mysql.format 来创建一个多插入点的查询语句，对id和值可以使用适当的转义处理 。下面是一个简单的例子:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> sql <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM ?? WHERE ?? = ?&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> inserts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token string">'id'</span><span class="token punctuation">,</span> userId<span class="token punctuation">]</span><span class="token punctuation">;</span>
sql <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> inserts<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这样你就获得了一个有效并且安全的查询语句，然后可以把它发送给数据库。如果你希望在发送给数据库之前就准备好查询语句，这种方法很有用。因为mysql.format是从sqlString.format派生而来的，所以你还可以选择传递stringifyObject 和timezone对象(但不强制要求)，并且允许您通过自定义的方式将对象转换成字符串，以及特定地区的时间和时区(location specific/timezone aware Date).</p> <h3 id="自定义格式"><a href="#自定义格式" class="header-anchor">#</a> <strong>自定义格式</strong></h3> <p>如果你想使用其他样式的转义格式，你可以在连接配置选项中自定义一个自定义的格式函数。如果你还想使用内置的escape()函数或其它的连接函数，可以访问connection对象。
下面是一个实现自定义格式的例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function-variable function">queryFormat</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">query<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>values<span class="token punctuation">)</span> <span class="token keyword">return</span> query<span class="token punctuation">;</span>
  <span class="token keyword">return</span> query<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\:(\w+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">txt<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>values<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">escape</span><span class="token punctuation">(</span>values<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> txt<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;UPDATE posts SET title = :title&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">&quot;Hello MySQL&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="获取插入行的id"><a href="#获取插入行的id" class="header-anchor">#</a> <strong>获取插入行的id</strong></h2> <p>如果你把一行插入到一个有自增主键的表中，可以这样获得插入的ID：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO posts SET ?'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>title<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>insertId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>当处理大数字的时候(超过javascript的Number类型的精度),你需要启用supportBigNumbers选项，以便把插入行的ID作为字符串类型读取出来，否者会抛出一个错误。</p> <p>当从数据库中查询的数字是一个big number类型的时候，也需要把supportBigNumbers选项设置为true，否则查询出来的数据由于精度限制，会进行四舍五入。</p> <h3 id="取得受影响的行数"><a href="#取得受影响的行数" class="header-anchor">#</a> <strong>取得受影响的行数</strong></h3> <p>你可以从 insert，update 或者 delete 子句中取得受影响的行数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'DELETE FROM posts WHERE title = &quot;wrong&quot;'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'deleted '</span> <span class="token operator">+</span> result<span class="token punctuation">.</span>affectedRows <span class="token operator">+</span> <span class="token string">' rows'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>取得被改变的行数</strong></p> <p>你可以从 update 子句取得被改变的行数。</p> <p>&quot;被改变的行数&quot; 不同于 &quot;受影响行数&quot; ，它不更新行数，而是改变值。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'UPDATE posts SET ...'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'changed '</span> <span class="token operator">+</span> result<span class="token punctuation">.</span>changedRows <span class="token operator">+</span> <span class="token string">' rows'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>获取连接ID</strong></p> <p>你可以取得MySQL的连接ID（“线程ID”），这是一个给定的连接，使用的是线程ID属性。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'connected as id '</span> <span class="token operator">+</span> connection<span class="token punctuation">.</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>并行执行查询</strong></p> <p>MySQL协议是顺序的，这意味着你需要多次连接执行并行查询。你可以使用池来管理连接，一个简单的办法是每传入一个http请求，就创建一个连接。</p> <h3 id="流式查询行"><a href="#流式查询行" class="header-anchor">#</a> 流式查询行</h3> <p>有的时候可能需要查询大量的数据行，然后在接收到这些数据行的时候一行行的处理它们。就像这样：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> query <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM posts'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
query
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理错误，这之后会触发 'end' 事件</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'fields'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fields</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 字段信息</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">row</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 暂停连接。如果你的处理过程涉及到 I/O 操作，这会很有用。</span>
    connection<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">processRow</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      connection<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 所有数据行都已经接收完毕</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <p>在上面的示例中，有几点需要注意：</p> <ul><li>通常会在接收到一定数量的数据行之后使用 pause() 来暂停连接。这个数量取决于数据行数量和大小。</li> <li>pause()/resume() 操作基于套接字和解析器。在调用 pause() 后可以保证不会继续触发 'result' 事件。</li> <li><strong>一定不能</strong>给流式查询行的 query() 调用提供回调函数。</li> <li>查询到数据行会触发 'result'，INSERT/UPDATE 查询成功的时候也会触发 'result'</li> <li>非常重要一点，不要暂停太久，否则会遇到 <em>错误：连接丢失：服务器已断开连接</em>。这个时间限制是在 MySQL 服务器中由 net_write_timeout setting 设置的。</li></ul> <p>此外，你可能需要知道，目前不可能在流式处理过程中处理单独的行列，它们总是完全缓存的。如果你在 MySQL 方面有流式处理大量字段的经验，希望你能在这里分享。</p></div> <h3 id="通过-streams2-管道输出"><a href="#通过-streams2-管道输出" class="header-anchor">#</a> 通过 Streams2 管道输出</h3> <p>查询对象提供了一个便利的方法 .stream([options]) 将查询事件封装在 Readable Streams2 对象中。这个流对象能通过管道简单的流向下游，并基于下游阻塞程度和 highWaterMark 选项自动提供暂停/恢复功能。流对象的 objectMode 参数设置为 true且不可改变（如果你需要一个字节流，那你就得转换流，像示例中的 objstream 那样）。</p> <p>示例，通过管道将查询结果输出到另一个流（最大缓冲 5 个对象），这很简单：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM posts'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>highWaterMark<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="多语句查询"><a href="#多语句查询" class="header-anchor">#</a> 多语句查询</h3> <p>由于安全因素（可能因为不正确的转义造成SQL注入攻击），默认情况下不允许多语句查询。不过可以在连接的时候放开这个限制。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>multipleStatements<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>一旦设置允许，就可以像执行其它查询那样执行多语句查询：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT 1; SELECT 2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token comment">// `results` is an array with one element for every statement in the query:</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [{1: 1}]</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [{2: 2}]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>除此之外，也可以流式处理多语句查询的返回结果：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> query <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT 1; SELECT 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
query
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'fields'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fields<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// the fields for the result rows that follow</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">row<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// index refers to the statement this result belongs to (starts at 0)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果查询中的某一条语句产生错误，则 Error 对象会有一个 err.index 属性用于指出是第几条语句导致的错误。一旦有错误发生，MySQL 会停止执行剩下的语句。</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>流式处理多语句查询的接口是试验性的，我期待着对它的反馈。</p></div> <h2 id="存储过程"><a href="#存储过程" class="header-anchor">#</a> <strong>存储过程</strong></h2> <p>你可以调用你的存储过程，这来自于你的查询，就像调用任何 mysql 驱动一样。如果存储过程产生多个结果集，作为多个语句查询的结果，它们会以同样的方式暴露在你面前。</p> <p><strong>join 重叠的列名</strong></p> <p>当执行 join 操作时，你可以取得类似的结果集来重叠列名。</p> <p>默认的方式是，node-mysql 将会按顺序覆盖从 MySQL 接收到的重叠列名，这会导致一些接收到的值不可用。</p> <p>另外，你也可以指定你想要的列，嵌套以下这样的表名：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>sql<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span> nestTables<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* results will be an array like this now:
  [{
    table1: {
      fieldA: '...',
      fieldB: '...',
    },
    table2: {
      fieldA: '...',
      fieldB: '...',
    },
  }, ...]
  */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>或者，使用一个字符串来分隔你合并的结果。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>sql<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span> nestTables<span class="token operator">:</span> <span class="token string">'_'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* results will be an array like this now:
  [{
    table1_fieldA: '...',
    table1_fieldB: '...',
    table2_fieldA: '...',
    table2_fieldB: '...',
  }, ...]
  */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="事务"><a href="#事务" class="header-anchor">#</a> <strong>事务</strong></h2> <p>在连接级别，简单事务支持是有效的：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO posts SET title=?'</span><span class="token punctuation">,</span> title<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> log <span class="token operator">=</span> <span class="token string">'Post '</span> <span class="token operator">+</span> result<span class="token punctuation">.</span>insertId <span class="token operator">+</span> <span class="token string">' added'</span><span class="token punctuation">;</span>
    connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO log SET data=?'</span><span class="token punctuation">,</span> log<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>  
      connection<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'success!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>请记住 beginTransaction()， commit() 和 rollback() 是简单方便的函数，这些函数分别执行 START TRANSACTION，COMMIT 和 ROLLBACK 命令。重要的是要理解在 MySQL 中的很多函数所引发的隐含提交，这在<a href="http://dev.mysql.com/doc/refman/5.5/en/implicit-commit.html" target="_blank" rel="noopener noreferrer">MySQL文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中是有相应的描述的。</p> <p><strong>Ping</strong></p> <p>连接可以使用connection.ping方法向服务器发送一个ping包，若服务器作出响应，将触发回调函数。如果有错误发生，err参数将会传递给回调函数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server responded to ping'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>超时</strong></p> <p>每个操作都可以使用一个可选的固定超时（timeout ）选项。这样你就可以为操作指定合适的超时时间。要注意的是超时并非MySQL 协议的内容，也不会通过客户端执行，这一点很重要。也就是说，当达到超时时间时，对应的连接将被终止，也不会再执行其它的操作。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 60秒后终止查询</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>sql<span class="token operator">:</span> <span class="token string">'SELECT COUNT(*) AS count FROM big_table'</span><span class="token punctuation">,</span> timeout<span class="token operator">:</span> <span class="token number">60000</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> rows</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&amp;&amp;</span> err<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">'PROTOCOL_SEQUENCE_TIMEOUT'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'too long to count table rows!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token string">' rows'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="错误处理"><a href="#错误处理" class="header-anchor">#</a> <strong>错误处理</strong></h2> <p>这个模块自带了一种统一的错误处理方法，你必须仔细查看以便写出健壮的应用程序。</p> <p>该模块创建的大多数错误都是JavaScript的Error对象实例。另外，它们通常还会附带两个额外的属性：</p> <ul><li>err.code:  <a href="http://dev.mysql.com/doc/refman/5.5/en/error-messages-server.html" target="_blank" rel="noopener noreferrer">MySQL服务器错误<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (比如'ER_ACCESS_DENIED_ERROR'), Node.js错误(比如'ECONNREFUSED')或者内部错误(比如'PROTOCOL_CONNECTION_LOST').</li> <li>err.fatal: 布尔型, 指出这个错误是否是终端连接对象。 如果错误不是来自MySQL协议操作，那这个属性不被定义。</li></ul> <p>致命错误会挂起所有的回调。在下面的例子中，试图连接到一个无效端口时触发一个致命错误。因此错误对象传递到了两个回调中：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> connection <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  port<span class="token operator">:</span> <span class="token number">84943</span><span class="token punctuation">,</span> <span class="token comment">// WRONG PORT</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'ECONNREFUSED'</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>fatal<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT 1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'ECONNREFUSED'</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>fatal<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>然而，正常的错误只返回给属于他们的回调函数。所以在下面的例子中，只有第一个回调会接收错误，第二个查询的会出错：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'USE name_of_db_that_does_not_exist'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> rows</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'ER_BAD_DB_ERROR'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT 1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> rows</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// null</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rows<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>最后但并非不重要：如果发生了一个致命的错误，但没有一个对应的回调，或者发生了一个正常的错误但没有属于他的回调，那么错误会向连接对象发出'error' 事件。下面的例子说明了这一点：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>connection<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'ER_BAD_DB_ERROR'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'USE name_of_db_that_does_not_exist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>注意：error事件在 node中很特殊。如果他们出现而没有绑定侦听器，会打印堆栈跟踪并杀死你的进程。</p> <p><strong>tl;dr</strong>: 这个模块不需要你处理那些静态错误。你总应当给你的方法调用提供回调函数。如果你想忽略这条建议并抑制掉未处理的错误，可以这样做：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// I am Chuck Norris:</span>
connection<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>异常（exception）的安全</strong></p> <p>这个模块是异常（exception）安全的。这意味着你可以持续使用它，它是你的一个回调函数，它会抛出一个错误，你可以使用'uncaughtException'或者一个域来捕获它。</p> <h2 id="类型测试"><a href="#类型测试" class="header-anchor">#</a> <strong>类型测试</strong></h2> <p>为了方便起见，这个驱动将会抛出 mysql 类型给本地的 JavaScript 默认类型。存在下面这些映射：</p> <p>**<em>*数字型（*<em>Number）</em></em></p> <ul><li>TINYINT</li> <li>SMALLINT</li> <li>INT</li> <li>MEDIUMINT</li> <li>YEAR</li> <li>FLOAT</li> <li>DOUBLE</li></ul> <p><strong>日期型（Date）</strong></p> <ul><li>TIMESTAMP</li> <li>DATE</li> <li>DATETIME</li></ul> <p><strong>Buffer类型</strong></p> <ul><li>TINYBLOB</li> <li>MEDIUMBLOB</li> <li>LONGBLOB</li> <li>BLOB</li> <li>BINARY</li> <li>VARBINARY</li> <li>BIT (最后一个字节将会填满0)</li></ul> <p><strong>字符创类型（String）</strong></p> <p><strong>注意</strong> 在二进制字符集合中的文本是作为一个 Buffer 返回的，相当于是一个字符串。</p> <ul><li>CHAR</li> <li>VARCHAR</li> <li>TINYTEXT</li> <li>MEDIUMTEXT</li> <li>LONGTEXT</li> <li>TEXT</li> <li>ENUM</li> <li>SET</li> <li>DECIMAL (可能超出浮点数的精度)</li> <li>BIGINT (可能超出浮点数的精度)</li> <li>TIME (可以映射成日期型（Date）, 但是日期是一个集合?)</li> <li>GEOMETRY (从来没使用过，如果你用过请联系我)</li></ul> <p>不推荐（将来可能消失/改变）关闭类型转换，但是你现在可以做这样的连接：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> connection <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>typeCast<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或者是在查询级别这么做：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>sql<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span> typeCast<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> query <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>你可以始终通过一个函数来处理类型转换。你可以给定一些列信息，就像数据库，表，类型和长度。如果你想申请自定义类型转换成指定的你可以处理的类型，那么回调函数是默认的。这里举个例子，将 TINYINT(1) 转换成 boolean：</p> <div class="language-jsjs line-numbers-mode"><pre class="language-text"><code>connection.query({
  sql: '...',
  typeCast: function (field, next) {
    if (field.type == 'TINY' &amp;&amp; field.length == 1) {
      return (field.string() == '1'); // 1 = true, 0 = false
    }
    return next();
  }
});
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>警告: 在你的自定义类型的回调函数中，你必须调用这三个 *<em>field*</em> 函数来解析。他们只能被调用一次（查看 讨论 #539）</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>field<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
field<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
field<span class="token punctuation">.</span><span class="token function">geometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
are aliases <span class="token keyword">for</span>
parser<span class="token punctuation">.</span><span class="token function">parseLengthCodedString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span><span class="token function">parseLengthCodedBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span><span class="token function">parseGeometryValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>你可以通过仔细查找，找到 field 函数：</p> <p>[RowDataPacket.prototype._typeCast</p> <p><strong>连接标志</strong></p> <p>无论何种原因，你要是想改变默认的连接标志，你可以使用连接选项标记。通过逗号分隔字符串，把条目添加到默认的标志中。如果你不想要默认的准备好的标志，你可以用一个负号。添加一个不在默认列表中的标记，仅需要写出标记名称，或者在标记前加一个+号（大小写敏感）。</p> <p><strong>请记住一些有用的标记，它们是没有被提供的标记（例如：*<em>Compression*</em>），它们还没有被指定。</strong></p> <p><strong>例子</strong></p> <p>下面例子中的黑名单 FOUND_ROWS 标记 来自默认的连接标记。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token string">&quot;mysql://localhost/test?flags=-FOUND_ROWS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="默认标记"><a href="#默认标记" class="header-anchor">#</a> <strong>默认标记</strong></h2> <p>下面的标记被发送是通过一个默认的新连接：</p> <ul><li>CONNECT_WITH_DB - 指定数据库在连接上的能力。</li> <li>FOUND_ROWS - 发送发现affectedRows行而受影响的行。</li> <li>IGNORE_SIGPIPE - 老的；无影响。</li> <li>IGNORE_SPACE - 让解析器忽略空格之前的（查询。）</li> <li>LOCAL_FILES - 可以使用 LOAD DATA LOCAL.</li> <li>LONG_FLAG</li> <li>LONG_PASSWORD - 使用改进的老密码验证版本。</li> <li>MULTI_RESULTS - 为 COM_QUERY 可以处理多个结果。</li> <li>ODBC Old; 无影响。</li> <li>PROTOCOL_41 - 使用4.1协议。</li> <li>PS_MULTI_RESULTS - 为 COM_STMT_EXECUTE 可以处理多个结果。</li> <li>RESERVED -  4.1 协议的老标记。</li> <li>SECURE_CONNECTION - 支持本地4.1认证。</li> <li>TRANSACTIONS - 询问事务状态标记。</li></ul> <p>另外，如果选项 multipleStatements 设置成 true，下面这些将会被发送：</p> <ul><li>MULTI_STATEMENTS - 每次查询或者准备声明，客户端都可能会发送多个子句。</li></ul> <h3 id="其他有用的标记"><a href="#其他有用的标记" class="header-anchor">#</a> <strong>其他有用的标记</strong></h3> <p>有其他一些可用的标记。他们可能会也可能不会起作用，但是仍然可用来指定。</p> <ul><li>COMPRESS</li> <li>INTERACTIVE</li> <li>NO_SCHEMA</li> <li>PLUGIN_AUTH</li> <li>REMEMBER_OPTIONS</li> <li>SSL</li> <li>SSL_VERIFY_SERVER_CERT</li></ul> <p><strong>调试和报告问题</strong></p> <p>如果你遇到问题，你可以在连接时激活调试模式来辅助：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>debug<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这将打印所有传入和传出的数据包到 stdout 上。你也可以限制调试包的数组类型，并传递至调试：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>debug<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'ComQueryPacket'</span><span class="token punctuation">,</span> <span class="token string">'RowDataPacket'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>限制调试查询和数据包。</p> <p>如果这篇文章没有帮助到你，你可以打开一个 GitHub 问题。一个好的 GitHub 问题会是这样：</p> <ul><li>尽可能减少代码的复制（如果可能的话）</li> <li>尽可能调试输出你的环境信息（mysql 版本，node版本，操作系统，等等）尽你的能力去收集。</li></ul> <p><strong>运行测试</strong></p> <p>测试套件分成两个部分：单元测试和集成测试。单元测试运行在任何机器上，而集成测试需要安装一个MySQL服务器实例。</p> <p><strong>运行单元测试</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token constant">FILTER</span><span class="token operator">=</span>unit npm test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>运行集成测试</strong></p> <p>设置环境变量MYSQL_DATABASE，MYSQL_HOST，MYSQL_PORT，MYSQL_USER 和 MYSQL_PASSWORD。MYSQL_SOCKET 可以被 MYSQL_HOST 和 MYSQL_PORT 替代连接至UNIX socket。之后运行 npm 测试。</p> <p>举例来说，如果你有一个 mysql 安装被运行在 localhost:3306 并且没有为 root 用户设置密码，运行：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>mysql <span class="token operator">-</span>u root <span class="token operator">-</span>e <span class="token string">&quot;CREATE DATABASE IF NOT EXISTS node_mysql_test&quot;</span>
<span class="token constant">MYSQL_HOST</span><span class="token operator">=</span>localhost <span class="token constant">MYSQL_PORT</span><span class="token operator">=</span><span class="token number">3306</span> <span class="token constant">MYSQL_DATABASE</span><span class="token operator">=</span>node_mysql_test <span class="token constant">MYSQL_USER</span><span class="token operator">=</span>root <span class="token constant">MYSQL_PASSWORD</span><span class="token operator">=</span> <span class="token constant">FILTER</span><span class="token operator">=</span>integration npm test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>那接下来就要做下面这些事：</p> <ul><li>预处理子句</li> <li>支持的编码格式不止于 UTF-8 / ASCII</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last update:</span> <span class="time">December 11, 2020 17:43</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/web/handbooks/guide/MySql/" class="prev"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon prev-icon"><path d="M906.783 588.79c-.02 8.499-6.882 15.36-15.38 15.37l-443.7-.01 75.704 191.682c2.52 6.42.482 13.763-5.038 17.91-5.52 4.168-13.138 4.147-18.616-.092L123.228 524.175a15.362 15.362 0 01-6-12.165c0-4.782 2.222-9.277 6-12.185L499.753 210.35a15.388 15.388 0 019.38-3.195c3.236 0 6.502 1.034 9.236 3.103 5.52 4.147 7.578 11.49 5.038 17.91L447.683 419.84l443.72-.01c8.498.01 15.36 6.881 15.36 15.36l.02 153.6z" fill="currentColor"></path></svg>
        MySql手册
      </a></span> <span class="next"><a href="/web/handbooks/guide/linux/">
        Linux语法
        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon next-icon"><path d="M906.772 512c0 4.772-2.211 9.267-5.99 12.175L524.257 813.66a15.37 15.37 0 01-18.616.092 15.368 15.368 0 01-5.038-17.91l75.714-191.672h-443.73c-8.488 0-15.36-6.881-15.36-15.36v-153.6c0-8.489 6.872-15.36 15.36-15.36h443.73l-75.714-191.682a15.358 15.358 0 015.048-17.91c5.51-4.158 13.128-4.137 18.606.092l376.525 289.485a15.323 15.323 0 015.99 12.165z" fill="currentColor"></path></svg></a></span></p></div> <!----> </main> <!----></div><div class="global-ui"><!----><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button title="Close (Esc)" class="pswp__button pswp__button--close"></button> <button title="Share" class="pswp__button pswp__button--share"></button> <button title="Toggle fullscreen" class="pswp__button pswp__button--fs"></button> <button title="Zoom in/out" class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button title="Previous (arrow left)" class="pswp__button pswp__button--arrow--left"></button> <button title="Next (arrow right)" class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><div id="live2d-widget" class="live2d-widget-container" style="position:fixed;right:65px;bottom:0px;width:135px;height:300px;z-index:99999;opacity:0.8;pointer-events:none;"><canvas id="live2d_canvas" width="135" height="300" class="live2d_canvas" style="position:absolute;left:0px;top:0px;width:135px;height:300px;"></canvas></div></div></div>
    <script src="/web/handbooks/assets/js/app.34fee4e2.js" defer></script><script src="/web/handbooks/assets/js/layout-Layout.e2428f23.js" defer></script><script src="/web/handbooks/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.6b13e837.js" defer></script><script src="/web/handbooks/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.2463fd57.js" defer></script><script src="/web/handbooks/assets/js/vendors~layout-Blog~layout-Layout.80e40fa9.js" defer></script><script src="/web/handbooks/assets/js/page-Node-MySQL官方文档--810d1eb0.e4ae1425.js" defer></script>
  </body>
</html>
